<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Markdown</title>
    <link rel="apple-touch-icon" sizes="180x180" href="./imatges/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./imatges/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./imatges/favicon-16x16.png">
    <link rel="manifest" href="./imatges/site.webmanifest">
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
     <link href="./output.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 h-screen">
    <div class="flex flex-col h-full">
        <!-- Header -->
        <div class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
            <div class="flex items-center justify-between px-4 py-3">
                <h1 class="text-xl font-bold text-gray-800 dark:text-gray-100">Editor de Markdown</h1>
                <div class="flex gap-2">
                    <button onclick="togglePreview()" 
                            class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm"
                            data-tooltip="Canviar tema">
                        <span id="previewToggleText">üëÅÔ∏è Amagar vista</span>
                    </button>
                    <button onclick="importFile()" 
                            class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                            data-tooltip="Obrir fitxer (Ctrl+O)">
                        üìÅ Obrir
                    </button>
                    <button onclick="exportFile()" 
                            class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm"
                            data-tooltip="Desar fitxer (Ctrl+S)">
                        üíæ Desar
                    </button>
                    <button onclick="showLocalStorageManager()" 
                            class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm"
                            data-tooltip="Gestionar documents guardats">
                        üìã Gestionar
                    </button>
                    <button onclick="clearEditor()" 
                            class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                            data-tooltip="Netejar tot l'editor">
                        üóëÔ∏è Netejar
                    </button>
                    <button id="themeToggle" 
                            onclick="toggleTheme()" 
                            class="px-3 py-1 bg-gray-600 dark:bg-gray-700 text-white rounded hover:bg-gray-700 dark:hover:bg-gray-600 text-sm"
                            data-tooltip="Canviar tema">
                        üåô Tema fosc
                    </button>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 px-4 py-2">
            <div class="flex flex-wrap gap-1">
                <!-- Men√∫ desplegable per t√≠tols (substitueix els botons H1, H2, H3) -->
                <div class="relative dropdown">
                    <button class="toolbar-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-1"
                            data-tooltip="Inserir t√≠tol"
                            onclick="toggleDropdown('headingDropdown')">
                        <span class="font-bold dark:text-gray-200 text-2xl">H</span>
                        <svg class="w-3 h-3 dark:text-gray-200 text-2xl" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    
                    <div id="headingDropdown" 
                        class="dropdown-content absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-md shadow-lg z-50 min-w-[160px] hidden">
                        <button onclick="insertText('# '); closeDropdown('headingDropdown')" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center gap-2">
                            <span class="font-bold text-2xl">H1</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">T√≠tol principal</span>
                        </button>
                        <button onclick="insertText('## '); closeDropdown('headingDropdown')" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center gap-2">
                            <span class="font-bold text-xl">H2</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">T√≠tol secundari</span>
                        </button>
                        <button onclick="insertText('### '); closeDropdown('headingDropdown')" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center gap-2">
                            <span class="font-bold text-lg">H3</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">T√≠tol terciari</span>
                        </button>
                        <button onclick="insertText('#### '); closeDropdown('headingDropdown')" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center gap-2">
                            <span class="font-bold">H4</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">T√≠tol quaternari</span>
                        </button>
                        <button onclick="insertText('##### '); closeDropdown('headingDropdown')" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center gap-2">
                            <span class="font-bold text-sm">H5</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">T√≠tol cinqu√®</span>
                        </button>
                        <button onclick="insertText('###### '); closeDropdown('headingDropdown')" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center gap-2">
                            <span class="font-bold text-xs">H6</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">T√≠tol sis√®</span>
                        </button>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <button onclick="insertText('\n'); closeDropdown('headingDropdown')" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 flex items-center gap-2">
                            <span class="text-sm">P</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">Par√†graf normal</span>
                        </button>
                        
                    </div>
                </div>
                <!--
                <button onclick="insertText('# ')" 
                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="T√≠tol 1"
                        data-tooltip="T√≠tol principal (H1)">
                    <span class="font-bold text-2xl dark:text-gray-200">H1</span>
                </button>
                <button onclick="insertText('## ')" 
                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="T√≠tol 2"
                        data-tooltip="T√≠tol secundari (H2)">
                    <span class="font-bold text-xl dark:text-gray-200">H2</span>
                </button>
                <button onclick="insertText('### ')" 
                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="T√≠tol 3"
                        data-tooltip="T√≠tol terciari (H3)">
                    <span class="font-bold text-lg dark:text-gray-200">H3</span>
                </button>
                <button onclick="insertText('#### ')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="T√≠tol 4"
                        data-tooltip="T√≠tol quart (H4)">
                    <span class="font-bold text-base dark:text-gray-200">H4</span>
                </button>
                <button onclick="insertText('##### ')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="T√≠tol 5"
                        data-tooltip="T√≠tol cinqu√® (H5)">
                    <span class="font-bold text-sm dark:text-gray-200">H5</span>
                </button>
                <button onclick="insertText('###### ')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="T√≠tol 6"
                        data-tooltip="T√≠tol sis√® (H6)">
                    <span class="font-bold text-xs dark:text-gray-200">H6</span>
                </button>
                -->
                <div class="border-l mx-2"></div>
                <button onclick="wrapText('**', '**')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded font-bold" 
                        title="Negreta"
                        data-tooltip="Text en negreta">
                    <span class="font-bold  text-lg dark:text-gray-200">B</span>
                </button>
                <button onclick="wrapText('*', '*')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded italic" 
                        title="Cursiva"
                        data-tooltip="Text en cursiva">
                    <span class="italic text-lg dark:text-gray-200">I</span>
                </button>
                <button onclick="wrapText('~~', '~~')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded line-through" 
                    title="Ratllat"
                    data-tooltip="Text ratllat">
                    <span class="line-through text-lg dark:text-gray-200">S</span>
                </button>
                <div class="border-l mx-2"></div>
                <button onclick="insertText('---\n')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="L√≠nia horitzontal"
                        data-tooltip="L√≠nia horitzontal">
                    <span class="font-bold text-lg dark:text-gray-200">‚Äî</span>
                </button>
                <button onclick="insertText('> ')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="Cita"
                        data-tooltip="Cita">
                    <span class="font-bold text-lg dark:text-gray-200">""</span>
                </button>
                <div class="border-l mx-2"></div>
                <button onclick="insertText('- ')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="Llista"
                        data-tooltip="Llista no numerada">
                    <span class="font-bold text-lg dark:text-gray-200">‚Ä¢ ‚â°</span>
                </button>
                <button onclick="insertText('1. ')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="Llista numerada"
                        data-tooltip="Llista numerada">
                    <span class="font-bold text-lg dark:text-gray-200">1. ‚â°</span>
                </button>
                <button onclick="insertText('- [ ] ')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="Llista de tasques"
                        data-tooltip="Llista de tasques">
                    <span class="font-bold text-lg dark:text-gray-200">‚òê ‚â°</span>
                </button>
                <div class="border-l mx-2"></div>
                <button onclick="insertText('| Columna 1 | Columna 2 |\n|----------|----------|\n| Cel¬∑la 1 | Cel¬∑la 2 |\n')" 
                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="Taula"
                        data-tooltip="Taula">
                    <span class="font-bold text-lg dark:text-gray-200">‚äû</span>
                </button>
                <button onclick="wrapText('[', '](url)')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="Enlla√ß"
                        >
                    <span class="font-bold text-lg dark:text-gray-200">üîó</span>
                </button>
                <button onclick="insertImage()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="Inserir imatge"
                        data-tooltip="Inserir imatge">
                    <span class="font-bold text-lg dark:text-gray-200">üñºÔ∏è</span>
                </button>
                <button onclick="wrapText('`', '`')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="Codi inline"
                        data-tooltip="Codi inline">
                    <span class="font-bold text-lg dark:text-gray-200">&lt;/&gt;</span>
                </button>
                <button onclick="insertText('```\n\n```\n')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" 
                        title="Bloc de codi"
                        data-tooltip="Bloc de codi">
                    <span class="font-bold text-lg dark:text-gray-200">‚ãØ</span>
                </button>
                <!-- Bot√≥ dropdown per emojis (afegir a la toolbar) -->
                <div class="relative dropdown">
                    <button class="toolbar-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-1"
                            data-tooltip="Inserir emoji"
                            onclick="toggleDropdown('emojiDropdown')">
                        <span class="dark:text-gray-200">üòÄ</span>
                        <svg class="w-3 h-3 dark:text-gray-200" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    
                    <div id="emojiDropdown" 
                    class="dropdown-content absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-md shadow-lg z-50 w-80 max-h-80 overflow-y-auto hidden">
                        <div class="p-2">
                            <div class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">Expressions</div>
                            <div class="grid grid-cols-8 gap-1 mb-3">
                                <button onclick="insertText('üòÄ'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":grinning:">üòÄ</button>
                                <button onclick="insertText('üòÑ'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":smile:">üòÑ</button>
                                <button onclick="insertText('üòÇ'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":joy:">üòÇ</button>
                                <button onclick="insertText('üòä'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":blush:">üòä</button>
                                <button onclick="insertText('üòç'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":heart_eyes:">üòç</button>
                                <button onclick="insertText('üòò'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":kissing_heart:">üòò</button>
                                <button onclick="insertText('üòâ'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":wink:">üòâ</button>
                                <button onclick="insertText('üòû'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":disappointed:">üòû</button>
                            </div>
                            
                            <div class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">Gestos</div>
                            <div class="grid grid-cols-8 gap-1 mb-3">
                                <button onclick="insertText('üëç'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":thumbsup:">üëç</button>
                                <button onclick="insertText('üëé'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":thumbsdown:">üëé</button>
                                <button onclick="insertText('üëå'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":ok_hand:">üëå</button>
                                <button onclick="insertText('üëè'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":clap:">üëè</button>
                                <button onclick="insertText('üôè'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":pray:">üôè</button>
                                <button onclick="insertText('üí™'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":muscle:">üí™</button>
                                <button onclick="insertText('üëã'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":wave:">üëã</button>
                                <button onclick="insertText('‚úã'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":raised_hand:">‚úã</button>
                            </div>
                            
                            <div class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">S√≠mbols</div>
                            <div class="grid grid-cols-8 gap-1 mb-3">
                                <button onclick="insertText('‚ö†Ô∏è'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":warning:">‚ö†Ô∏è</button>
                                <button onclick="insertText('‚ùó'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":exclamation:">‚ùó</button>
                                <button onclick="insertText('‚ùì'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":question:">‚ùì</button>
                                <button onclick="insertText('‚úÖ'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":white_check_mark:">‚úÖ</button>
                                <button onclick="insertText('‚ùå'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":x:">‚ùå</button>
                                <button onclick="insertText('üí°'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":bulb:">üí°</button>
                                <button onclick="insertText('üî•'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":fire:">üî•</button>
                                <button onclick="insertText('üöÄ'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":rocket:">üöÄ</button>
                            </div>
                            
                            <div class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">Programaci√≥</div>
                            <div class="grid grid-cols-8 gap-1">
                                <button onclick="insertText('üêõ'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":bug:">üêõ</button>
                                <button onclick="insertText('üöß'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":construction:">üöß</button>
                                <button onclick="insertText('üìù'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":memo:">üìù</button>
                                <button onclick="insertText('üìÅ'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":file_folder:">üìÅ</button>
                                <button onclick="insertText('üíª'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":computer:">üíª</button>
                                <button onclick="insertText('üîç'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":mag:">üîç</button>
                                <button onclick="insertText('‚öôÔ∏è'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":gear:">‚öôÔ∏è</button>
                                <button onclick="insertText('üîß'); closeDropdown('emojiDropdown')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" title=":wrench:">üîß</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div id="mainContent" class="flex flex-col lg:flex-row flex-1 overflow-hidden relative">
            <!-- Drag overlay -->
            <div id="dragOverlay" class="drag-overlay hidden">
                <div class="text-center text-blue-600">
                    <div class="text-4xl mb-4">üìÑ</div>
                    <div class="text-xl font-semibold">Deixa el fitxer Markdown aqu√≠</div>
                    <div class="text-sm opacity-75 mt-2">Formats suportats: .md, .txt</div>
                </div>
            </div>
            
            <!-- Editor -->
            <div id="editorContainer" class="w-full lg:w-1/2 bg-white dark:bg-gray-800 border-r dark:border-gray-700 transition-all duration-300 flex flex-col min-h-0">
                <div class="p-4 bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600 flex-shrink-0">
                    <h2 class="font-semibold text-gray-700 dark:text-gray-200">Editor</h2>
                </div>
                <textarea
                    id="editor"
                    class="w-full flex-1 p-4 border-none outline-none resize-none editor-textarea min-h-[60vh] lg:min-h-0 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                    placeholder="Escriu el teu Markdown aqu√≠ o arrossega un fitxer..."
                    oninput="updatePreview()"
                ></textarea>
            </div>

            <!-- Preview -->
            <div id="previewContainer" class="w-full lg:w-1/2 bg-white dark:bg-gray-800 transition-all duration-300 flex flex-col min-h-0">
                <div class="p-4 bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600 flex-shrink-0">
                    <h2 class="font-semibold text-gray-700 dark:text-gray-200">Vista pr√®via</h2>
                </div>
                <div id="preview" class="p-4 overflow-y-auto flex-1 preview-content min-h-[40vh] lg:min-h-0 dark:text-gray-100"></div>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <!-- <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-50 flex items-center justify-center">
        <div id="modalContent" class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-y-auto"> -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div id="modalContent" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-y-auto">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".md,.txt" style="display: none;" onchange="handleFileImport(event)">

    <script>
        // Variables globals
        let currentFileName = 'document.md';
        let currentModalResolve = null;
        let previewVisible = true;
        let isDragging = false;

        // Variables per al tema
let isDarkMode = false;

function initializeTheme() {
    // Comprovar prefer√®ncia guardada
    console.log("üöÄ ~ initializeTheme ~ "

    )
    const savedTheme = localStorage.getItem('markdownEditorTheme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    // Aplicar tema guardat o prefer√®ncia del sistema
    isDarkMode = savedTheme === 'dark' || (savedTheme === null && prefersDark);
    applyTheme();
    updateThemeButton();
}
    

// Alternar entre tema fosc i clar
function toggleTheme() {

    isDarkMode = !isDarkMode;
    
    applyTheme();
    updateThemeButton();
    
    // Guardar prefer√®ncia
    localStorage.setItem('markdownEditorTheme', isDarkMode ? 'dark' : 'light');
}

// Aplicar el tema seleccionat
function applyTheme() {
    // const html = document.documentElement;
    
    // if (isDarkMode) {
    //     html.classList.add('dark');
    // } else {
    //     html.classList.remove('dark');
    // }
        const body = document.documentElement;
    
    if (isDarkMode) {
        body.classList.add('dark');
    } else {
        body.classList.remove('dark');
    }
}

// Actualitzar text i icona del bot√≥ de tema
function updateThemeButton() {
    const themeButton = document.getElementById('themeToggle');
    if (themeButton) {
        const icon = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        const text = isDarkMode ? 'Tema clar' : 'Tema fosc';
        themeButton.innerHTML = `${icon} ${text}`;
    }
}

        // Funcions del modal
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        // Alternar vista pr√®via
        function togglePreview() {
            const editorContainer = document.getElementById('editorContainer');
            const previewContainer = document.getElementById('previewContainer');
            const toggleText = document.getElementById('previewToggleText');
            const mainContent = document.getElementById('mainContent');
            const editor = document.getElementById('editor');
            
            previewVisible = !previewVisible;
            
            if (previewVisible) {
                // Mostrar vista pr√®via
                previewContainer.classList.remove('hidden');
                toggleText.textContent = 'üëÅÔ∏è Amagar vista';
                
                // Responsive: En m√≤bil (lg:) dividir verticalment, en desktop horitzontalment
                editorContainer.className = 'w-full lg:w-1/2 bg-white border-r transition-all duration-300 flex flex-col min-h-0';
                previewContainer.className = 'w-full lg:w-1/2 bg-white transition-all duration-300 flex flex-col min-h-0';
                mainContent.className = 'flex flex-col lg:flex-row flex-1 overflow-hidden relative';
                editor.className = 'w-full flex-1 p-4 border-none outline-none resize-none editor-textarea min-h-[60vh] lg:min-h-0';
            } else {
                // Amagar vista pr√®via
                previewContainer.classList.add('hidden');
                toggleText.textContent = 'üëÅÔ∏è Mostrar vista';
                
                // Editor a pantalla completa
                editorContainer.className = 'w-full bg-white transition-all duration-300 flex flex-col min-h-0';
                mainContent.className = 'flex flex-1 overflow-hidden relative';
                editor.className = 'w-full flex-1 p-4 border-none outline-none resize-none editor-textarea';
            }
        }

        function showAlert(message, type = 'info') {
            return new Promise((resolve) => {
                const iconMap = {
                    'info': 'üí°',
                    'success': '‚úÖ', 
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå'
                };
                
                const colorMap = {
                    'info': 'bg-blue-100 text-blue-800 border-blue-300',
                    'success': 'bg-green-100 text-green-800 border-green-300',
                    'warning': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                    'error': 'bg-red-100 text-red-800 border-red-300'
                };

                const content = `
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">${iconMap[type]}</span>
                            <h3 class="text-lg font-semibold text-gray-800">Informaci√≥</h3>
                        </div>
                        <div class="mb-6 p-3 rounded border ${colorMap[type]}">
                            ${message}
                        </div>
                        <div class="flex justify-end">
                            <button onclick="resolveModal(true)" 
                                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                D'acord
                            </button>
                        </div>
                    </div>
                `;
                
                currentModalResolve = resolve;
                showModal(content);
            });
        }

        function showConfirm(message, confirmText = 'Acceptar', cancelText = 'Cancel¬∑lar') {
            return new Promise((resolve) => {
                const content = `
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">‚ùì</span>
                            <h3 class="text-lg font-semibold text-gray-800">Confirmaci√≥</h3>
                        </div>
                        <div class="mb-6 text-gray-700">
                            ${message}
                        </div>
                        <div class="flex justify-end gap-3">
                            <button onclick="resolveModal(false)" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                                ${cancelText}
                            </button>
                            <button onclick="resolveModal(true)" 
                                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                `;
                
                currentModalResolve = resolve;
                showModal(content);
            });
        }

        function showPrompt(message, defaultValue = '', placeholder = '') {
            return new Promise((resolve) => {
                const content = `
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">‚úèÔ∏è</span>
                            <h3 class="text-lg font-semibold text-gray-800">Entrada requerida</h3>
                        </div>
                        <div class="mb-4 text-gray-700">
                            ${message}
                        </div>
                        <input type="text" id="promptInput" value="${defaultValue}" placeholder="${placeholder}"
                               class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6">
                        <div class="flex justify-end gap-3">
                            <button onclick="resolveModal(null)" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                                Cancel¬∑lar
                            </button>
                            <button onclick="resolveModal(document.getElementById('promptInput').value)" 
                                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                Acceptar
                            </button>
                        </div>
                    </div>
                `;
                
                currentModalResolve = resolve;
                showModal(content);
                
                // Focus en l'input i seleccionar text
                setTimeout(() => {
                    const input = document.getElementById('promptInput');
                    if (input) {
                        input.focus();
                        input.select();
                        
                        // Enter per acceptar
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                resolveModal(input.value);
                            }
                        });
                    }
                }, 100);
            });
        }

        function showLocationChoice(message, option1 = 'Disc dur', option2 = 'Local Storage') {
            return new Promise((resolve) => {
                const content = `
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">üìç</span>
                            <h3 class="text-lg font-semibold text-gray-800">Triar ubicaci√≥</h3>
                        </div>
                        <div class="mb-6 text-gray-700">
                            ${message}
                        </div>
                        <div class="flex flex-col gap-3">
                            <button onclick="resolveModal('disk')" 
                                    class="flex items-center p-4 border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                                <span class="text-2xl mr-3">üíæ</span>
                                <div class="text-left">
                                    <div class="font-semibold">${option1}</div>
                                    <div class="text-sm text-gray-600">Desar/obrir fitxers al teu ordinador</div>
                                </div>
                            </button>
                            <button onclick="resolveModal('storage')" 
                                    class="flex items-center p-4 border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                                <span class="text-2xl mr-3">üóÑÔ∏è</span>
                                <div class="text-left">
                                    <div class="font-semibold">${option2}</div>
                                    <div class="text-sm text-gray-600">Desar/obrir del navegador (local)</div>
                                </div>
                            </button>
                        </div>
                        <div class="flex justify-end mt-4">
                            <button onclick="resolveModal(null)" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                                Cancel¬∑lar
                            </button>
                        </div>
                    </div>
                `;
                
                currentModalResolve = resolve;
                showModal(content);
            });
        }

        // Funci√≥ per inserir imatges
async function insertImage() {
    try {
        // Demanar URL de la imatge
        const imageUrl = await showPrompt(
            'Introdueix l\'URL de la imatge:', 
            '', 
            'https://example.com/imatge.jpg'
        );
        
        if (!imageUrl) return; // L'usuari ha cancel¬∑lat
        
        // Validar que sembli una URL v√†lida
        if (!isValidUrl(imageUrl)) {
            await showAlert('L\'URL introdu√Øda no sembla v√†lida. Assegura\'t que comenci per http:// o https://', 'warning');
            return;
        }
        
        // Demanar descripci√≥/text alternatiu
        const altText = await showPrompt(
            'Introdueix una descripci√≥ per la imatge (text alternatiu):', 
            '', 
            'Descripci√≥ de la imatge'
        );
        
        if (altText === null) return; // L'usuari ha cancel¬∑lat
        
        // Crear la marca Markdown per la imatge
        const markdownImage = `![${altText || 'Imatge'}](${imageUrl})`;
        
        // Inserir al editor
        insertText(markdownImage);
        
        await showAlert('Imatge inserida correctament!', 'success');
        
    } catch (error) {
        await showAlert('Error en inserir la imatge: ' + error.message, 'error');
    }
}

// Funci√≥ auxiliar per validar URLs
function isValidUrl(string) {
    try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
    } catch (_) {
        return false;
    }
}

        // Tancar modal fent clic fora
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                resolveModal(null);
            }
        });

        // Tancar modal amb Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !document.getElementById('modalOverlay').classList.contains('hidden')) {
                resolveModal(null);
            }
        });

        // Configurar drag & drop
function setupDragAndDrop() {
    const editor = document.getElementById('editor');
    const dragOverlay = document.getElementById('dragOverlay');
    const mainContent = document.getElementById('mainContent');
    
    // Evitar el comportament per defecte del navegador
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        mainContent.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Mostrar overlay quan s'arrossega sobre l'√†rea
    ['dragenter', 'dragover'].forEach(eventName => {
        mainContent.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        mainContent.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        if (!isDragging) {
            isDragging = true;
            dragOverlay.classList.remove('hidden');
        }
    }
    
    function unhighlight() {
        isDragging = false;
        dragOverlay.classList.add('hidden');
    }
    
    // Gestionar l'arxiu quan es deixa anar
    mainContent.addEventListener('drop', handleDrop, false);
    
    async function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            const file = files[0];
            
            // Comprovar si √©s un fitxer de text v√†lid
            if (file.type === 'text/markdown' || file.type === 'text/plain' || 
                file.name.endsWith('.md') || file.name.endsWith('.txt')) {
                
                // Comprovar si l'editor t√© contingut
                const currentContent = editor.value.trim();
                let shouldReplace = true;
                
                if (currentContent) {
                    shouldReplace = await showConfirm(
                        `L'editor ja t√© contingut. Vols substituir-lo pel contingut del fitxer "${file.name}"?<br><br>` +
                        '‚ö†Ô∏è <strong>Atenci√≥:</strong> El contingut actual es perdr√† si no l\'has desat.',
                        'S√≠, substituir',
                        'Cancel¬∑lar'
                    );
                }
                
                if (shouldReplace) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        editor.value = e.target.result;
                        updatePreview();
                        currentFileName = file.name;
                        await showAlert(`Fitxer "${file.name}" carregat correctament mitjan√ßant drag & drop.`, 'success');
                    };
                    reader.onerror = async function() {
                        await showAlert('Error en llegir el fitxer.', 'error');
                    };
                    reader.readAsText(file);
                }
            } else {
                await showAlert(
                    'Tipus de fitxer no suportat.<br><br>' +
                    'üìÑ <strong>Formats acceptats:</strong> .md, .txt', 
                    'warning'
                );
            }
        }
    }
}

// Sistema de tooltips avan√ßat (opcional)
class TooltipManager {
    constructor() {
        this.tooltip = null;
        this.init();
    }

    init() {
        // Crear element tooltip
        this.tooltip = document.createElement('div');
        this.tooltip.className = 'tooltip-advanced';
        this.tooltip.style.cssText = `
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 9999;
            white-space: nowrap;
        `;
        document.body.appendChild(this.tooltip);

        // Afegir listeners
        this.addEventListeners();
    }

    addEventListeners() {
        document.addEventListener('mouseover', (e) => {
            const target = e.target.closest('[data-tooltip]');
            if (target) {
                this.show(target, target.getAttribute('data-tooltip'));
            }
        });

        document.addEventListener('mouseout', (e) => {
            const target = e.target.closest('[data-tooltip]');
            if (target) {
                this.hide();
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (this.tooltip.style.opacity === '1') {
                this.position(e);
            }
        });
    }

    show(element, text) {
        this.tooltip.textContent = text;
        this.tooltip.style.opacity = '1';
    }

    hide() {
        this.tooltip.style.opacity = '0';
    }

    position(event) {
        const tooltip = this.tooltip;
        const x = event.clientX;
        const y = event.clientY;
        
        // Posicionar tooltip
        tooltip.style.left = (x + 10) + 'px';
        tooltip.style.top = (y - 30) + 'px';

        // Ajustar si surt de la pantalla
        const rect = tooltip.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            tooltip.style.left = (x - rect.width - 10) + 'px';
        }
        if (rect.top < 0) {
            tooltip.style.top = (y + 20) + 'px';
        }
    }
}

// Funcions per gestionar el dropdown
function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    const button = dropdown.previousElementSibling;
    const parentDropdown = button.closest('.dropdown');
    
    // Tancar altres dropdowns oberts
    document.querySelectorAll('.dropdown-content.show').forEach(dd => {
        if (dd.id !== dropdownId) {
            dd.classList.remove('show');
            dd.closest('.dropdown').classList.remove('open');
        }
    });
    
    // Alternar el dropdown actual
    if (dropdown.classList.contains('show')) {
        closeDropdown(dropdownId);
    } else {
        openDropdown(dropdownId);
    }
}

function openDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    const parentDropdown = dropdown.closest('.dropdown');
    
    dropdown.classList.add('show');
    parentDropdown.classList.add('open');
    
    // Ajustar posici√≥ si surt de la pantalla
    setTimeout(() => {
        const rect = dropdown.getBoundingClientRect();
        const windowWidth = window.innerWidth;
        
        if (rect.right > windowWidth - 10) {
            dropdown.style.left = 'auto';
            dropdown.style.right = '0';
        }
    }, 10);
}

function closeDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    const parentDropdown = dropdown.closest('.dropdown');
    
    dropdown.classList.remove('show');
    parentDropdown.classList.remove('open');
    
    // Resetar posici√≥
    dropdown.style.left = '';
    dropdown.style.right = '';
}

// Tancar dropdown en fer clic fora
document.addEventListener('click', function(event) {
    const dropdowns = document.querySelectorAll('.dropdown');
    
    dropdowns.forEach(dropdown => {
        if (!dropdown.contains(event.target)) {
            const dropdownContent = dropdown.querySelector('.dropdown-content');
            if (dropdownContent && dropdownContent.classList.contains('show')) {
                closeDropdown(dropdownContent.id);
            }
        }
    });
});

// Tancar dropdown amb Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        document.querySelectorAll('.dropdown-content.show').forEach(dropdown => {
            closeDropdown(dropdown.id);
        });
    }
});

// Mapa d'emojis m√©s comuns
const emojiMap = {
    // Expressions
    ':smile:': 'üòÑ',
    ':grinning:': 'üòÄ',
    ':joy:': 'üòÇ',
    ':laughing:': 'üòÜ',
    ':wink:': 'üòâ',
    ':blush:': 'üòä',
    ':heart_eyes:': 'üòç',
    ':kissing_heart:': 'üòò',
    ':relaxed:': '‚ò∫Ô∏è',
    ':satisfied:': 'üòå',
    ':grin:': 'üòÅ',
    ':stuck_out_tongue:': 'üòõ',
    ':stuck_out_tongue_winking_eye:': 'üòú',
    ':disappointed:': 'üòû',
    ':worried:': 'üòü',
    ':angry:': 'üò†',
    ':rage:': 'üò°',
    ':cry:': 'üò¢',
    ':sob:': 'üò≠',
    ':fearful:': 'üò®',
    ':tired_face:': 'üò´',
    
    // Gestos i mans
    ':thumbsup:': 'üëç',
    ':thumbsdown:': 'üëé',
    ':ok_hand:': 'üëå',
    ':punch:': 'üëä',
    ':fist:': '‚úä',
    ':clap:': 'üëè',
    ':pray:': 'üôè',
    ':point_up:': '‚òùÔ∏è',
    ':point_down:': 'üëá',
    ':point_left:': 'üëà',
    ':point_right:': 'üëâ',
    ':raised_hand:': '‚úã',
    ':muscle:': 'üí™',
    ':wave:': 'üëã',
    
    // Cors i s√≠mbols
    ':heart:': '‚ù§Ô∏è',
    ':broken_heart:': 'üíî',
    ':two_hearts:': 'üíï',
    ':sparkling_heart:': 'üíñ',
    ':heartpulse:': 'üíó',
    ':blue_heart:': 'üíô',
    ':green_heart:': 'üíö',
    ':yellow_heart:': 'üíõ',
    ':purple_heart:': 'üíú',
    ':star:': '‚≠ê',
    ':star2:': 'üåü',
    ':sparkles:': '‚ú®',
    ':fire:': 'üî•',
    ':boom:': 'üí•',
    
    // Advert√®ncies i s√≠mbol
    ':warning:': '‚ö†Ô∏è',
    ':exclamation:': '‚ùó',
    ':question:': '‚ùì',
    ':grey_exclamation:': '‚ùï',
    ':grey_question:': '‚ùî',
    ':x:': '‚ùå',
    ':heavy_check_mark:': '‚úÖ',
    ':white_check_mark:': '‚úÖ',
    ':o:': '‚≠ï',
    ':no_entry:': '‚õî',
    ':heavy_multiplication_x:': '‚úñÔ∏è',
    ':heavy_plus_sign:': '‚ûï',
    ':heavy_minus_sign:': '‚ûñ',
    
    // Tecnologia
    ':computer:': 'üíª',
    ':laptop:': 'üíª',
    ':phone:': 'üì±',
    ':iphone:': 'üì±',
    ':camera:': 'üì∑',
    ':video_camera:': 'üìπ',
    ':tv:': 'üì∫',
    ':radio:': 'üìª',
    ':cd:': 'üíø',
    ':dvd:': 'üìÄ',
    ':floppy_disk:': 'üíæ',
    ':minidisc:': 'üíΩ',
    ':electric_plug:': 'üîå',
    ':battery:': 'üîã',
    
    // Objectes i eines
    ':bulb:': 'üí°',
    ':gear:': '‚öôÔ∏è',
    ':wrench:': 'üîß',
    ':hammer:': 'üî®',
    ':nut_and_bolt:': 'üî©',
    ':hocho:': 'üî™',
    ':gun:': 'üî´',
    ':bomb:': 'üí£',
    ':key:': 'üîë',
    ':lock:': 'üîí',
    ':unlock:': 'üîì',
    ':bell:': 'üîî',
    ':bookmark:': 'üîñ',
    ':link:': 'üîó',
    
    // Transport
    ':car:': 'üöó',
    ':taxi:': 'üöï',
    ':bus:': 'üöå',
    ':train:': 'üöã',
    ':bike:': 'üö¥',
    ':airplane:': '‚úàÔ∏è',
    ':rocket:': 'üöÄ',
    ':ship:': 'üö¢',
    ':boat:': '‚õµ',
    ':anchor:': '‚öì',
    
    // Natura
    ':sunny:': '‚òÄÔ∏è',
    ':cloud:': '‚òÅÔ∏è',
    ':umbrella:': '‚òî',
    ':snowflake:': '‚ùÑÔ∏è',
    ':snowman:': '‚õÑ',
    ':zap:': '‚ö°',
    ':cyclone:': 'üåÄ',
    ':ocean:': 'üåä',
    ':earth_americas:': 'üåé',
    ':earth_africa:': 'üåç',
    ':earth_asia:': 'üåè',
    ':new_moon:': 'üåë',
    ':full_moon:': 'üåï',
    ':crescent_moon:': 'üåô',
    
    // Animals
    ':dog:': 'üê∂',
    ':cat:': 'üê±',
    ':mouse:': 'üê≠',
    ':hamster:': 'üêπ',
    ':rabbit:': 'üê∞',
    ':bear:': 'üêª',
    ':panda_face:': 'üêº',
    ':koala:': 'üê®',
    ':tiger:': 'üêØ',
    ':lion_face:': 'ü¶Å',
    ':cow:': 'üêÆ',
    ':pig:': 'üê∑',
    ':monkey_face:': 'üêµ',
    ':see_no_evil:': 'üôà',
    ':hear_no_evil:': 'üôâ',
    ':speak_no_evil:': 'üôä',
    
    // Menjar
    ':apple:': 'üçé',
    ':banana:': 'üçå',
    ':grapes:': 'üçá',
    ':strawberry:': 'üçì',
    ':cherry:': 'üçí',
    ':peach:': 'üçë',
    ':pizza:': 'üçï',
    ':hamburger:': 'üçî',
    ':fries:': 'üçü',
    ':hotdog:': 'üå≠',
    ':beer:': 'üç∫',
    ':wine_glass:': 'üç∑',
    ':coffee:': '‚òï',
    ':tea:': 'üçµ',
    ':birthday:': 'üéÇ',
    ':cake:': 'üç∞',
    
    // Activitats
    ':soccer:': '‚öΩ',
    ':basketball:': 'üèÄ',
    ':football:': 'üèà',
    ':baseball:': '‚öæ',
    ':tennis:': 'üéæ',
    ':golf:': '‚õ≥',
    ':trophy:': 'üèÜ',
    ':medal:': 'üèÖ',
    ':musical_note:': 'üéµ',
    ':notes:': 'üé∂',
    ':headphones:': 'üéß',
    ':microphone:': 'üé§',
    ':guitar:': 'üé∏',
    ':game_die:': 'üé≤',
    ':dart:': 'üéØ',
    
    // Temps i dates
    ':clock1:': 'üïê',
    ':clock2:': 'üïë',
    ':clock3:': 'üïí',
    ':clock12:': 'üïõ',
    ':alarm_clock:': '‚è∞',
    ':hourglass:': '‚åõ',
    ':calendar:': 'üìÖ',
    ':date:': 'üìÖ',
    
    // Programaci√≥ i GitHub
    ':bug:': 'üêõ',
    ':construction:': 'üöß',
    ':memo:': 'üìù',
    ':pencil:': '‚úèÔ∏è',
    ':pencil2:': '‚úèÔ∏è',
    ':page_facing_up:': 'üìÑ',
    ':clipboard:': 'üìã',
    ':file_folder:': 'üìÅ',
    ':open_file_folder:': 'üìÇ',
    ':scissors:': '‚úÇÔ∏è',
    ':pushpin:': 'üìå',
    ':paperclip:': 'üìé',
    ':mag:': 'üîç',
    ':mag_right:': 'üîé',
};

// Funci√≥ per convertir text amb emojis
function convertEmojis(text) {
    // Buscar totes les coincid√®ncies de :emoji_name:
    return text.replace(/:[\w+-]+:/g, function(match) {
        const emoji = emojiMap[match];
        return emoji || match; // Si no existeix l'emoji, mantenir el text original
    });
}

// Actualitzar la funci√≥ updatePreview per incloure conversi√≥ d'emojis
function updatePreview() {
    if (previewVisible) {
        const editorContent = document.getElementById('editor').value;
        const preview = document.getElementById('preview');
        
        // Primer processar el Markdown
        let htmlContent = marked.parse(editorContent);
        
        // Despr√©s convertir els emojis
        htmlContent = convertEmojis(htmlContent);
        
        preview.innerHTML = htmlContent;
    }
}
// Funci√≥ per inserir shortcode d'emoji
function insertEmojiShortcode(shortcode) {
    insertText(shortcode);
    // For√ßar actualitzaci√≥ de la vista pr√®via
    setTimeout(updatePreview, 10);
}

// Funci√≥ alternativa per al dropdown que insereix shortcodes
function createEmojiShortcodeButton(emoji, shortcode, title) {
    return `<button onclick="insertEmojiShortcode('${shortcode}'); closeDropdown('emojiDropdown')" 
                    class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-lg" 
                    title="${title} (${shortcode})">${emoji}</button>`;
}

// Exemple d'√∫s per al dropdown amb shortcodes
function showEmojiShortcodes() {
    // Aquest √©s un exemple de com podries modificar el dropdown
    // per inserir shortcodes en lloc d'emojis directes
    const emojiHTML = `
        ${createEmojiShortcodeButton('‚ö†Ô∏è', ':warning:', 'Advert√®ncia')}
        ${createEmojiShortcodeButton('üí°', ':bulb:', 'Bombeta')}
        ${createEmojiShortcodeButton('üî•', ':fire:', 'Foc')}
        ${createEmojiShortcodeButton('üöÄ', ':rocket:', 'Coet')}
        ${createEmojiShortcodeButton('üêõ', ':bug:', 'Error')}
        ${createEmojiShortcodeButton('‚úÖ', ':white_check_mark:', 'Marcat')}
        ${createEmojiShortcodeButton('‚ùå', ':x:', 'X')}
        ${createEmojiShortcodeButton('‚ùó', ':exclamation:', 'Exclamaci√≥')}
    `;
    return emojiHTML;
}

        // Inicialitzar l'editor
        document.addEventListener('DOMContentLoaded', async function() {

            initializeTheme()

            new TooltipManager();
            // Comprovar si cal mostrar documents d'exemple
            await checkExampleDocuments();
            
            // Configurar drag & drop
            setupDragAndDrop();
            
            updatePreview();
            
            // Detectar canvis de mida de pantalla per ajustar el layout responsiu
            window.addEventListener('resize', function() {
                // For√ßar actualitzaci√≥ del layout responsive
                if (previewVisible) {
                    const mainContent = document.getElementById('mainContent');
                    const editorContainer = document.getElementById('editorContainer');
                    const previewContainer = document.getElementById('previewContainer');
                    const editor = document.getElementById('editor');
                    
                    // Reassignar classes per assegurar responsivitat
                    editorContainer.className = 'w-full lg:w-1/2 bg-white border-r transition-all duration-300 flex flex-col min-h-0';
                    previewContainer.className = 'w-full lg:w-1/2 bg-white transition-all duration-300 flex flex-col min-h-0';
                    mainContent.className = 'flex flex-col lg:flex-row flex-1 overflow-hidden relative';
                    editor.className = 'w-full flex-1 p-4 border-none outline-none resize-none editor-textarea min-h-[60vh] lg:min-h-0';
                }
            });
        });

        // Comprovar i gestionar documents d'exemple
        async function checkExampleDocuments() {
            const userPreference = localStorage.getItem('skipExampleDocs');
            
            if (userPreference === 'true') {
                // L'usuari ha dit que no vol exemples, deixar l'editor buit
                return;
            }
            
            const savedDocs = JSON.parse(localStorage.getItem('markdownDocs') || '{}');
            const hasExistingDocs = Object.keys(savedDocs).length > 0;
            const editorHasContent = document.getElementById('editor').value.trim() !== '';
            
            if (!hasExistingDocs && !editorHasContent) {
                // Preguntar a l'usuari si vol documents d'exemple
                const wantsExamples = await showConfirm(
                    'Vols que afegim alguns documents d\'exemple per comen√ßar?<br><br>' +
                    'üí° Els documents d\'exemple t\'ajudaran a entendre com funciona l\'editor.',
                    'S√≠, afegir exemples',
                    'No, comen√ßar buit'
                );
                
                if (wantsExamples) {
                    // Afegir documents d'exemple
                    addExampleDocuments();
                    // Carregar el primer document d'exemple
                    const exampleDoc = `# Benvingut a l'Editor de Markdown!

Aquest √©s un document d'exemple per mostrar-te les capacitats de l'editor.

## ‚ú® Caracter√≠stiques principals

- **Vista pr√®via en temps real** mentre escrius
- **Barra d'eines completa** per a tots els elements Markdown
- **Emmagatzematge local** i exportaci√≥ a fitxers
- **Disseny responsiu** que funciona en m√≤bils
- **Drag & Drop** per obrir fitxers f√†cilment

## üõ†Ô∏è Elements que pots utilitzar

### Text amb format
Pots utilitzar **text en negreta**, *text en cursiva*, ~~text ratllat~~ i \`codi inline\`.

### Llistes
- Element 1
- Element 2
  - Sub-element
  - Un altre sub-element

### Llistes numeradas
1. Primer element
2. Segon element
3. Tercer element

### Llistes de tasques
- [x] Tasca completada
- [ ] Tasca pendent
- [ ] Una altra tasca

### Codi
\`\`\`javascript
function salutacio() {
    console.log("Hola, m√≥n!");
}
salutacio();
\`\`\`

### Taules
| Funcionalitat | Descripci√≥ | Estat |
|---------------|------------|-------|
| Editor | Escriptura de Markdown | ‚úÖ |
| Vista pr√®via | Renderitzaci√≥ HTML | ‚úÖ |
| Drag & Drop | Obrir fitxers | ‚úÖ |

### Cites
> "La millor manera d'aprendre Markdown √©s practicant."
> 
> ‚Äî Un usuari satisfet

### Enlla√ßos
Pots crear [enlla√ßos a webs externes](https://example.com) o refer√®ncies internes.

---

## üöÄ Comen√ßa a editar!

Prova la barra d'eines de dalt, arrossega fitxers a l'editor, o simplement comen√ßa a escriure. 

**Consell:** Utilitza el bot√≥ üëÅÔ∏è per amagar aquesta vista pr√®via si necessites m√©s espai.`;
                    
                    document.getElementById('editor').value = exampleDoc;
                    updatePreview();
                } else {
                    // L'usuari no vol exemples, recordar aquesta decisi√≥
                    localStorage.setItem('skipExampleDocs', 'true');
                }
            }
        }

        // Afegir documents d'exemple al Local Storage
        function addExampleDocuments() {
            const exampleDocs = {
                'exemple-basic.md': {
                    content: '# Document d\'exemple\n\nAquest √©s un document d\'exemple per provar l\'editor.\n\n## Caracter√≠stiques\n\n- **Negreta** i *cursiva*\n- Llistes\n- [Enlla√ßos](https://example.com)\n\n```javascript\n// Codi d\'exemple\nconsole.log("Hola m√≥n!");\n```',
                    lastModified: new Date().toISOString()
                },
                'notes-personals.md': {
                    content: '# Notes personals\n\n## Tasques pendents\n\n- [ ] Revisar editor\n- [ ] Afegir m√©s funcions\n- [x] Provar Local Storage\n\n## Ideas\n\n> L\'editor de Markdown √©s molt √∫til per prendre notes r√†pides.\n\nPuc guardar documents tant al disc dur com al Local Storage.',
                    lastModified: new Date(Date.now() - 86400000).toISOString() // 1 dia abans
                },
                'guia-markdown.md': {
                    content: '# Guia r√†pida de Markdown\n\n## T√≠tols\n```\n# T√≠tol 1\n## T√≠tol 2\n### T√≠tol 3\n```\n\n## Format de text\n- **Negreta**: `**text**`\n- *Cursiva*: `*text*`\n- ~~Ratllat~~: `~~text~~`\n- `Codi`: `` `text` ``\n\n## Llistes\n```\n- Element 1\n- Element 2\n\n1. Element 1\n2. Element 2\n```\n\n## Enlla√ßos\n```\n[Text](URL)\n```',
                    lastModified: new Date(Date.now() - 172800000).toISOString() // 2 dies abans
                }
            };
            localStorage.setItem('markdownDocs', JSON.stringify(exampleDocs));
        }

        function resolveModal(value) {
            if (currentModalResolve) {
                const resolve = currentModalResolve;
                currentModalResolve = null;
                hideModal();
                resolve(value);
            }
        }

        // Actualitzar vista pr√®via
        function updatePreview() {
            if (previewVisible) {
                const editorContent = document.getElementById('editor').value;
                const preview = document.getElementById('preview');

                console.log("üöÄ ~ updatePreview ~ marked:", marked)
                preview.innerHTML = marked.parse(editorContent);
                
            }
        }

        // Inserir text a la posici√≥ del cursor
        function insertText(text) {
            const editor = document.getElementById('editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const currentValue = editor.value;
            
            editor.value = currentValue.substring(0, start) + text + currentValue.substring(end);
            editor.selectionStart = editor.selectionEnd = start + text.length;
            editor.focus();
            updatePreview();
        }

        // Embolicar text seleccionat
        function wrapText(startText, endText) {
            const editor = document.getElementById('editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const currentValue = editor.value;
            
            if (selectedText) {
                editor.value = currentValue.substring(0, start) + startText + selectedText + endText + currentValue.substring(end);
                editor.selectionStart = start + startText.length;
                editor.selectionEnd = start + startText.length + selectedText.length;
            } else {
                editor.value = currentValue.substring(0, start) + startText + endText + currentValue.substring(end);
                editor.selectionStart = editor.selectionEnd = start + startText.length;
            }
            
            editor.focus();
            updatePreview();
        }

        // Importar fitxer
        async function importFile() {
            await showOpenDialog();
        }

        // Mostrar di√†leg d'obertura
        async function showOpenDialog() {
            const location = await showLocationChoice('D\'on vols obrir el document?');
            if (!location) return;
            
            if (location === 'disk') {
                // Obrir des del disc dur - activar selector de fitxers
                document.getElementById('fileInput').click();
            } else {
                // Obrir del Local Storage
                await showLocalStorageDocuments();
            }
        }

        // Mostrar documents del Local Storage
        async function showLocalStorageDocuments() {
            try {
                const savedDocs = JSON.parse(localStorage.getItem('markdownDocs') || '{}');
                const docNames = Object.keys(savedDocs);
                
                if (docNames.length === 0) {
                    await showAlert('No hi ha documents guardats al Local Storage.<br><br>üí° <strong>Consell:</strong> Desa primer algun document per poder-lo obrir despr√©s.', 'info');
                    return;
                }
                
                const selectedDoc = await showDocumentSelector(savedDocs, docNames, 'open');
                if (selectedDoc) {
                    await loadFromLocalStorage(selectedDoc);
                }
                
            } catch (error) {
                await showAlert('Error en llegir del Local Storage: ' + error.message, 'error');
            }
        }

        // Selector de documents
        function showDocumentSelector(savedDocs, docNames, action = 'open') {
            return new Promise((resolve) => {
                let docList = '<div class="max-h-64 overflow-y-auto">';
                docNames.forEach((name, index) => {
                    const doc = savedDocs[name];
                    const lastModified = new Date(doc.lastModified).toLocaleString('ca-ES');
                    const actionText = action === 'open' ? 'Obrir' : 'Seleccionar';
                    docList += `
                        <div class="flex items-center justify-between p-3 border-b hover:bg-gray-50">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${name}</div>
                                <div class="text-sm text-gray-600">${lastModified}</div>
                            </div>
                            <button onclick="resolveModal('${name}')" 
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                ${actionText}
                            </button>
                        </div>
                    `;
                });
                docList += '</div>';

                const content = `
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">üìÑ</span>
                            <h3 class="text-lg font-semibold text-gray-800">Documents guardats</h3>
                        </div>
                        ${docList}
                        <div class="flex justify-end mt-4">
                            <button onclick="resolveModal(null)" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                                Cancel¬∑lar
                            </button>
                        </div>
                    </div>
                `;
                
                currentModalResolve = resolve;
                showModal(content);
            });
        }

        // Carregar document del Local Storage
        async function loadFromLocalStorage(fileName) {
            try {
                const savedDocs = JSON.parse(localStorage.getItem('markdownDocs') || '{}');
                const doc = savedDocs[fileName];
                
                if (doc) {
                    document.getElementById('editor').value = doc.content;
                    updatePreview();
                    currentFileName = fileName;
                    await showAlert(`Document "${fileName}" carregat correctament.`, 'success');
                } else {
                    await showAlert('Document no trobat.', 'error');
                }
            } catch (error) {
                await showAlert('Error en carregar del Local Storage: ' + error.message, 'error');
            }
        }

        // Gestionar importaci√≥ de fitxer
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Comprovar si l'editor t√© contingut
            const currentContent = document.getElementById('editor').value.trim();
            let shouldReplace = true;
            
            if (currentContent) {
                shouldReplace = await showConfirm(
                    `L'editor ja t√© contingut. Vols substituir-lo pel contingut del fitxer "${file.name}"?<br><br>` +
                    '‚ö†Ô∏è <strong>Atenci√≥:</strong> El contingut actual es perdr√† si no l\'has desat.',
                    'S√≠, substituir',
                    'Cancel¬∑lar'
                );
            }
            
            if (shouldReplace) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    document.getElementById('editor').value = e.target.result;
                    updatePreview();
                    currentFileName = file.name;
                    await showAlert(`Fitxer "${file.name}" carregat correctament.`, 'success');
                };
                reader.readAsText(file);
            }
            
            // Netejar l'input per permetre seleccionar el mateix fitxer de nou
            event.target.value = '';
        }

        // Exportar fitxer
        async function exportFile() {
            await showSaveDialog();
        }

        // Mostrar di√†leg de desament
        async function showSaveDialog() {
            const content = document.getElementById('editor').value;
            if (!content.trim()) {
                await showAlert('No hi ha contingut per desar.', 'warning');
                return;
            }

            const fileName = await showPrompt('Nom del fitxer:', currentFileName, 'document.md');
            if (!fileName) return;

            const location = await showLocationChoice('On vols desar el document?');
            if (!location) return;
            
            if (location === 'disk') {
                // Desar al disc dur
                saveToFile(content, fileName);
            } else {
                // Desar al Local Storage
                await saveToLocalStorage(content, fileName);
            }
        }

        // Desar al disc dur
        function saveToFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName.endsWith('.md') ? fileName : fileName + '.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            currentFileName = fileName;
        }

        // Desar al Local Storage
        async function saveToLocalStorage(content, fileName) {
            try {
                // Obtenir llista de documents guardats
                const savedDocs = JSON.parse(localStorage.getItem('markdownDocs') || '{}');
                
                // Afegir o actualitzar document
                savedDocs[fileName] = {
                    content: content,
                    lastModified: new Date().toISOString()
                };
                
                // Guardar al Local Storage
                localStorage.setItem('markdownDocs', JSON.stringify(savedDocs));
                
                currentFileName = fileName;
                await showAlert(`Document "${fileName}" desat al Local Storage correctament.`, 'success');
            } catch (error) {
                await showAlert('Error en desar al Local Storage: ' + error.message, 'error');
            }
        }

        // Netejar editor
        async function clearEditor() {
            const confirmed = await showConfirm('Est√†s segur que vols netejar tot el contingut?', 'S√≠, netejar', 'Cancel¬∑lar');
            if (confirmed) {
                document.getElementById('editor').value = '';
                updatePreview();
                currentFileName = 'document.md';
            }
        }

        // Gestor del Local Storage
        async function showLocalStorageManager() {
            try {
                const savedDocs = JSON.parse(localStorage.getItem('markdownDocs') || '{}');
                const docNames = Object.keys(savedDocs);
                
                if (docNames.length === 0) {
                    await showAlert('No hi ha documents guardats al Local Storage.', 'info');
                    return;
                }
                
                await showStorageManager(savedDocs, docNames);
                
            } catch (error) {
                await showAlert('Error en gestionar el Local Storage: ' + error.message, 'error');
            }
        }

        // Interf√≠cie del gestor d'emmagatzematge
        function showStorageManager(savedDocs, docNames) {
            return new Promise((resolve) => {
                let docList = '<div class="max-h-64 overflow-y-auto mb-4">';
                docNames.forEach((name, index) => {
                    const doc = savedDocs[name];
                    const lastModified = new Date(doc.lastModified).toLocaleString('ca-ES');
                    docList += `
                        <div class="flex items-center justify-between p-3 border-b hover:bg-gray-50">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${name}</div>
                                <div class="text-sm text-gray-600">${lastModified}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="loadDocument('${name}')" 
                                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                    Carregar
                                </button>
                                <button onclick="deleteDocument('${name}')" 
                                        class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                });
                docList += '</div>';

                const content = `
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">üìã</span>
                            <h3 class="text-lg font-semibold text-gray-800">Gesti√≥ de documents</h3>
                        </div>
                        ${docList}
                        <div class="flex justify-between">
                            <button onclick="clearAllDocuments()" 
                                    class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                üóëÔ∏è Eliminar tots
                            </button>
                            <button onclick="hideModal(); modalResolve(null)" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                                Tancar
                            </button>
                        </div>
                    </div>
                `;
                
                modalResolve = resolve;
                showModal(content);
                
                // Funcions globals per als botons del modal
                window.loadDocument = async (name) => {
                    hideModal();
                    await loadFromLocalStorage(name);
                };
                
                window.deleteDocument = async (name) => {
                    const confirmed = await showConfirm(`Est√†s segur que vols eliminar "${name}"?`, 'S√≠, eliminar', 'Cancel¬∑lar');
                    if (confirmed) {
                        await deleteFromLocalStorage(name);
                        // Recarregar el gestor
                        setTimeout(() => showLocalStorageManager(), 100);
                    } else {
                        // Tornar al gestor
                        setTimeout(() => showLocalStorageManager(), 100);
                    }
                };
                
                window.clearAllDocuments = async () => {
                    const confirmed = await showConfirm('Est√†s segur que vols eliminar tots els documents del Local Storage?', 'S√≠, eliminar tot', 'Cancel¬∑lar');
                    if (confirmed) {
                        localStorage.removeItem('markdownDocs');
                        await showAlert('Tots els documents han estat eliminats.', 'success');
                    } else {
                        // Tornar al gestor
                        setTimeout(() => showLocalStorageManager(), 100);
                    }
                };
            });
        }

        // Eliminar document del Local Storage
        async function deleteFromLocalStorage(docName) {
            try {
                const savedDocs = JSON.parse(localStorage.getItem('markdownDocs') || '{}');
                
                if (savedDocs[docName]) {
                    delete savedDocs[docName];
                    localStorage.setItem('markdownDocs', JSON.stringify(savedDocs));
                    await showAlert(`Document "${docName}" eliminat correctament.`, 'success');
                } else {
                    await showAlert('Document no trobat.', 'error');
                }
            } catch (error) {
                await showAlert('Error en eliminar del Local Storage: ' + error.message, 'error');
            }
        }

        // Dreceres de teclat
        document.getElementById('editor').addEventListener('keydown', async function(e) {
            // Ctrl+B per negreta
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                wrapText('**', '**');
            }
            // Ctrl+I per cursiva
            else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                wrapText('*', '*');
            }
            // Ctrl+S per desar
            else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                await exportFile();
            }
            // Ctrl+O per obrir
            else if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                await importFile();
            }
            // Tab per indentar
            else if (e.key === 'Tab') {
                e.preventDefault();
                insertText('    ');
            }
        });
    </script>
</body>
</html>